name: Release Management

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install build twine

    - name: Generate version number
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          # Auto-increment version based on release type
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          VERSION=$(python tools/build/bump_version.py --last-version "$LAST_TAG" --bump "$RELEASE_TYPE")
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"

    - name: Update version in files
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        python tools/build/update_version.py --version "$VERSION"

    - name: Generate changelog
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        python tools/build/generate_changelog.py --version "$VERSION" --output CHANGELOG_LATEST.md

    - name: Create ROM analysis report
      run: |
        python tools/analysis/generate_release_report.py --version "${{ steps.version.outputs.VERSION }}"

    - name: Build documentation
      run: |
        cd docs/
        sphinx-build -b html . _build/html
        tar -czf ../docs-${{ steps.version.outputs.VERSION }}.tar.gz -C _build/html .

    - name: Package tools
      run: |
        python -m build
        tar -czf tools-${{ steps.version.outputs.VERSION }}.tar.gz tools/

    - name: Create Git tag (if workflow_dispatch)
      if: github.event_name == 'workflow_dispatch'
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "$VERSION" -m "Release $VERSION"
        git push origin "$VERSION"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: Release ${{ steps.version.outputs.VERSION }}
        body_path: CHANGELOG_LATEST.md
        files: |
          dist/*
          docs-${{ steps.version.outputs.VERSION }}.tar.gz
          tools-${{ steps.version.outputs.VERSION }}.tar.gz
          ROM_ANALYSIS_REPORT.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update project board
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        python tools/github/update_project_board.py --release-version "$VERSION"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-release:
    name: Release Notifications
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: Get release info
      id: release
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Notify Discord (if configured)
      if: env.DISCORD_WEBHOOK_URL != ''
      run: |
        curl -H "Content-Type: application/json" \
             -d "{
               \"content\": \"ðŸŽ‰ DQ3R Release ${{ steps.release.outputs.VERSION }} is now available!\\n\\nCheck out the latest improvements to our Dragon Quest III analysis tools and documentation.\\n\\nDownload: ${{ github.event.repository.html_url }}/releases/tag/${{ steps.release.outputs.VERSION }}\"
             }" \
             "$DISCORD_WEBHOOK_URL"
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: Update documentation site
      run: |
        echo "Documentation will be auto-deployed by the CI pipeline"
